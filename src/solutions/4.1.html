<!DOCTYPE html>
<!--
ðŸ§© 4.1: Loading states
ðŸŽ¯ Goal: Improve the loading state accessibility
-->
<html lang="en">

<head>
  <title>Solution #4.1</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans:400,600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/theme.css">
  <link rel="stylesheet" href="4.1.css">
</head>

<body>
  <main class="content">
    <h1 class="title-xl">Loading states</h1>

    <div class="g-card">
      <!-- ðŸ’¡ Solution:
        - Replace disabled with aria-disabled to remain focused while loading.
        - Add aria-live to the loading element no announce when it starts/ends.
        - Add aria-busy to the content being loaded. Although it's not well supported.
      -->
      <div>
        <button class="btn btnPrimary js-luckyTrigger">
          Load lucky numbers
        </button>

        <div class="luckyArea">

          <div class="js-luckyEmpty">
            No lucky numbers yet.
          </div>

          <!-- Use aria-live to let the user know about the loading.
              Note: Do NOT use it on the element that will contain the loaded content,
              otherwise the AT would announce the entire content, which can be annoying. -->
          <div class="js-luckyLoader" aria-live="polite"></div>

          <div class="js-luckyTarget js-isHidden">
            <p>The lucky numbers are <span class="js-luckyNrs"></span>.</p>
          </div>
        </div>
        <p>A <a href="#fake-link" class="link">dummy link</a> for demo.</p>
      </div>
    </div>
  </main>

  <script>
    const elLuckyTrigger = document.getElementsByClassName('js-luckyTrigger')[0];
    const elLuckyLoader = document.getElementsByClassName('js-luckyLoader')[0];
    const elLuckyEmpty = document.getElementsByClassName('js-luckyEmpty')[0];
    const elLuckyTarget = document.getElementsByClassName('js-luckyTarget')[0];
    const elLuckyNrs = document.getElementsByClassName('js-luckyNrs')[0];

    const getRandomNr = () => Math.floor(Math.random() * 9) + 1;
    const loadingTime = 2500 // 2.5s          

    elLuckyTrigger.addEventListener('click', function (e) {
      const isDisabled = ignoreIfDisabled(e)
      if (isDisabled) return false

      // Use "aria-disabled="true" instead of "disabled" to allow the button
      // to be focused, even when during the loading state.
      elLuckyTrigger.setAttribute('aria-disabled', 'true')
      elLuckyEmpty.classList.add('js-isHidden')

      // Let AT know it's loading.
      elLuckyLoader.classList.remove('sr-only')
      elLuckyLoader.innerHTML = `Loading numbers...`

      elLuckyTarget.classList.add('js-isHidden');
      // aria-busy isn't supported by many browsers, so use aria-hidden too.
      elLuckyTarget.setAttribute('aria-busy', 'true');
      elLuckyTarget.setAttribute('aria-hidden', 'true');

      setTimeout(() => {
        // Display the lucky numbers!
        elLuckyNrs.textContent = `${getRandomNr()} and ${getRandomNr()}`
        elLuckyTarget.classList.remove('js-isHidden');
        elLuckyTarget.setAttribute('aria-busy', 'false')
        elLuckyTarget.setAttribute('aria-hidden', 'false');

        // Let AT know the loading was complete.
        elLuckyLoader.innerHTML = `Numbers loaded!`
        elLuckyLoader.classList.add('sr-only')

        // Make the trigger button clickable again. 
        elLuckyTrigger.removeAttribute('aria-disabled');
      }, loadingTime)
    })

    function ignoreIfDisabled(event) {
      const isDisabled = event.target.getAttribute('aria-disabled') === 'true';

      if (isDisabled) {
        event.preventDefault();
        event.target.blur(); // prevent focus on click.
        console.log('disabled - click ignored')
        return true
      }

      return false
    }
  </script>
</body>

</html>